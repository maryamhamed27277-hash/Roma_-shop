<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roma Shop</title>
  <style>
    :root{
      --bg:#071028; --card:#0b1220; --muted:#94a3b8; --accent:#f59e0b;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family: 'Noto Sans Arabic', Tahoma, Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071028 0%,#071130 100%);color:#e6eef8;min-height:100vh}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#0b1b2b,#071028)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(45deg,#ef4444,#f97316);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .prices{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .pkg{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
    .pkg h3{margin:0 0 6px 0}
    .price{font-weight:700;color:var(--accent)}
    form{display:flex;flex-direction:column;gap:10px}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
    button{background:var(--accent);border:none;color:#07202a;padding:10px;border-radius:10px;cursor:pointer}
    .small{color:var(--muted);font-size:13px}
    footer{text-align:center;padding:12px;color:var(--muted)}
    /* admin */
    .admin-panel{max-height:70vh;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right}
    th{background:rgba(255,255,255,0.02);font-weight:700}
    .badge{padding:6px 8px;border-radius:999px;font-size:13px}
    .status-pending{background:#f59e0b;color:#07202a}
    .status-done{background:#10b981;color:#022c22}
    .muted-ghost{color:rgba(230,238,248,0.6)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:50}
    .modal.open{display:flex}
    .panel{width:520px;max-width:95%}
    .center{display:flex;flex-direction:column;gap:10px}
    @media(max-width:980px){main{grid-template-columns:1fr} .side{position:relative}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">RS</div>
      <div>
        <h1>Roma Shop</h1>
        <div class="small">بيع متابعين إنستجرام — دفع فودافون كاش</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="openAdminBtn">لوحة التحكم</button>
    </div>
  </header>

  <main>
    <!-- LEFT: واجهة العميل -->
    <section class="card">
      <h2>باقات المتابعين</h2>
      <div class="small">السعر = عدد المتابعين × 0.2 جنيه (مثال: 50 متابع = 10 ج)</div>
      <div style="height:12px"></div>

      <div class="prices" id="packages"></div>

      <div style="height:14px"></div>
      <div class="card">
        <h3>اختيار مخصص</h3>
        <div class="small">أدخل عدد المتابعين والسعر سيظهر تلقائياً</div>
        <input id="customCount" type="number" placeholder="مثلاً 150 أو 1250 (لما فوق 1000 اترك خاص)" min="1">
        <div class="small">السعر: <span id="customPrice">0</span> ج</div>
        <div style="height:8px"></div>
        <button id="buyCustom">اختيار هذا العدد</button>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <h3>اطلب الآن</h3>
        <form id="orderForm">
          <select id="selectedPackage" required>
            <option value="">اختار الباقة أو اختر مخصص</option>
          </select>
          <input id="igUser" type="text" placeholder="يوزر إنستجرام (مثال: @username)" required>
          <input id="phone" type="text" placeholder="رقم الموبايل (010xxxxxxx)" required>
          <textarea id="notes" rows="3" placeholder="ملاحظات (اختياري)"></textarea>
          <label class="small muted-ghost">ارفع صورة إيصال دفع فودافون كاش</label>
          <input id="receipt" type="file" accept="image/*" required>
          <div class="small">رقم التحويل: <strong>01031090116</strong></div>
          <div style="height:6px"></div>
          <div style="display:flex;gap:8px">
            <button type="submit" style="flex:1">إرسال الطلب</button>
            <button type="button" id="clearForm" style="background:#ef4444;color:white">مسح الاستمارة</button>
          </div>
        </form>
      </div>
    </section>

    <!-- RIGHT: لوحة الادمن (مخفية لحد ما يدخل بكلمة السر) -->
    <aside class="card side">
      <div class="card">
        <h3>الحساب</h3>
        <div class="small">لوحة التحكم خاصة بك فقط. للدخول اضغط "لوحة التحكم" وأدخل كلمة السر.</div>
        <div style="height:10px"></div>
        <div class="small">كلمة سر الأدمن: <strong>مخفية</strong></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>معلومات</h3>
        <div class="small">عند الإرسال، سيطلب اليوزر رفع إيصال التحويل وكتابة يوزر الحساب ورقم للتواصل.</div>
      </div>
    </aside>
  </main>

  <footer>
    Roma Shop • مصمم للعمل مع Firebase
  </footer>

  <!-- مودال إدخال باسورد الأدمن -->
  <div class="modal" id="adminModal">
    <div class="panel card center">
      <h3>تسجيل دخول الأدمن</h3>
      <input id="adminPassword" type="password" placeholder="أدخل كلمة السر">
      <div style="display:flex;gap:8px">
        <button id="adminLogin">دخول</button>
        <button id="closeAdminModal">إغلاق</button>
      </div>
      <div class="small">لوحة التحكم محمية بكلمة سر محلية (M20071224m).</div>
    </div>
  </div>

  <!-- مودال لوحة التحكم -->
  <div class="modal" id="adminPanelModal">
    <div class="panel card" style="max-height:85vh;overflow:auto">
      <h3>لوحة التحكم — Roma Shop</h3>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">مجموع الطلبات: <span id="statCount">0</span></div>
        <div style="display:flex;gap:8px">
          <button id="adminLogout" style="background:#ef4444">خروج</button>
          <button id="closeAdminPanel">إغلاق</button>
        </div>
      </div>
      <div class="admin-panel" style="margin-top:12px">
        <table>
          <thead>
            <tr><th>وقت</th><th>الباقة</th><th>يوزر</th><th>تليفون</th><th>المبلغ</th><th>الإيصال</th><th>الحالة</th><th>إجراءات</th></tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- imports Firebase (modular) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, doc,
      onSnapshot, query, orderBy, serverTimestamp, deleteDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ---------- استخدم هنا config اللي انت عملته في Firebase Console ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCg7c0q2nKJHykS2Qpp0ldoutG_29OBYkU",
      authDomain: "romashop-62bf8.firebaseapp.com",
      projectId: "romashop-62bf8",
      storageBucket: "romashop-62bf8.firebasestorage.app",
      messagingSenderId: "830956550573",
      appId: "1:830956550573:web:8f40bedb6d05c87eecc924",
      measurementId: "G-6KWHET1BWV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- باقات جاهزة ----------
    const packages = [50,100,150,200,250,300,350,400,450,500,600,700,800,900,1000];

    // helpers
    function priceFor(count){ return Math.round(count * 0.2 * 100) / 100; }
    function fmtDate(ts){
      try{
        if(!ts) return '-';
        if(ts.toDate) return ts.toDate().toLocaleString('ar-EG');
        return new Date(ts).toLocaleString('ar-EG');
      }catch(e){ return '-';}
    }

    // render الباقات والاختيارات
    const packagesEl = document.getElementById('packages');
    const selectedPackage = document.getElementById('selectedPackage');
    packages.forEach(c=>{
      const div = document.createElement('div'); div.className='pkg';
      div.innerHTML = `<h3>${c} متابع</h3><div class="price">${priceFor(c)} ج</div><div class="small">سعر لكل متابع ${(priceFor(c)/c).toFixed(3)} ج</div><div style="height:8px"></div><button data-count="${c}">اختار</button>`;
      packagesEl.appendChild(div);

      // option in select
      const opt = document.createElement('option'); opt.value = c; opt.textContent = `${c} متابع — ${priceFor(c)} ج`;
      selectedPackage.appendChild(opt);
    });

    document.querySelectorAll('.pkg button').forEach(b=>{
      b.addEventListener('click', e=>{
        const cnt = e.target.dataset.count;
        selectedPackage.value = cnt;
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

    // custom count
    const customCount = document.getElementById('customCount');
    const customPrice = document.getElementById('customPrice');
    customCount.addEventListener('input', e=>{
      const v = parseInt(e.target.value)||0;
      customPrice.innerText = priceFor(v) + ' ج';
    });
    document.getElementById('buyCustom').addEventListener('click', ()=>{
      const v = parseInt(customCount.value)||0;
      if(v <= 0){ alert('اكتب عدد صحيح أكبر من 0'); return; }
      selectedPackage.value = 'custom-' + v;
      const opt = Array.from(selectedPackage.options).find(o=>o.value === selectedPackage.value);
      if(!opt){
        const newOpt = document.createElement('option'); newOpt.value = selectedPackage.value; newOpt.textContent = `${v} متابع — ${priceFor(v)} ج (مخصص)`; selectedPackage.appendChild(newOpt);
      }
      selectedPackage.value = 'custom-' + v;
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // ---------- ارسال الطلب ----------
    const orderForm = document.getElementById('orderForm');
    orderForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const selVal = selectedPackage.value;
        if(!selVal){ alert('اختار باقة أو أدخل مخصص'); return; }
        let count;
        if(selVal.startsWith('custom-')) count = parseInt(selVal.split('-')[1]) || 0;
        else count = parseInt(selVal);

        if(!count || count <= 0){ alert('عدد غير صالح'); return; }

        const igUser = document.getElementById('igUser').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const notes = document.getElementById('notes').value.trim();
        const receiptFile = document.getElementById('receipt').files[0];
        if(!igUser || !phone || !receiptFile){ alert('اكمل جميع الحقول وارفق الإيصال'); return; }

        // ارفع الصورة إلى Storage
        const uniquePath = `receipts/${Date.now()}_${Math.random().toString(36).slice(2)}_${receiptFile.name}`;
        const storageRef = sRef(storage, uniquePath);
        await uploadBytes(storageRef, receiptFile);
        const receiptURL = await getDownloadURL(storageRef);

        // احفظ الطلب في Firestore
        await addDoc(collection(db, 'orders'), {
          packageCount: count,
          price: priceFor(count),
          igUser, phone, notes,
          receiptURL,
          receiptPath: uniquePath,
          status: 'قيد المراجعة ⏳',
          createdAt: serverTimestamp()
        });

        alert('✅ تم إرسال طلبك بنجاح — سيتم مراجعته قريباً');
        orderForm.reset();
      }catch(err){
        console.error(err);
        alert('حصل خطأ أثناء إرسال الطلب، جرب مرة تانية');
      }
    });

    document.getElementById('clearForm').addEventListener('click', ()=>orderForm.reset());

    // ---------- ادمن: فتح المودال والتحقق من كلمة السر ----------
    const adminBtn = document.getElementById('openAdminBtn');
    const adminModal = document.getElementById('adminModal');
    const adminPanelModal = document.getElementById('adminPanelModal');
    const adminLoginBtn = document.getElementById('adminLogin');
    const adminPasswordInput = document.getElementById('adminPassword');
    const closeAdminModal = document.getElementById('closeAdminModal');
    const closeAdminPanel = document.getElementById('closeAdminPanel');
    const adminLogout = document.getElementById('adminLogout');

    const ADMIN_PASSWORD = 'M20071224m'; // كلمة السر اللي طلبتها

    adminBtn.addEventListener('click', ()=>{ adminModal.classList.add('open'); adminPasswordInput.value=''; adminPasswordInput.focus(); });

    closeAdminModal.addEventListener('click', ()=>adminModal.classList.remove('open'));
    closeAdminPanel.addEventListener('click', ()=>adminPanelModal.classList.remove('open'));

    adminLoginBtn.addEventListener('click', ()=>{
      const pw = adminPasswordInput.value;
      if(pw === ADMIN_PASSWORD){
        sessionStorage.setItem('roma_admin','1');
        adminModal.classList.remove('open');
        openAdminPanel();
      } else {
        alert('كلمة السر خاطئة');
      }
    });

    adminLogout.addEventListener('click', ()=>{
      sessionStorage.removeItem('roma_admin');
      adminPanelModal.classList.remove('open');
      stopOrdersListener();
    });

    // اختار يفتح لوحة الادمن لو محفوظه
    if(sessionStorage.getItem('roma_admin') === '1'){
      openAdminPanel();
    }

    // ---------- رصد الطلبات في الوقت الحقيقي واظهارها ----------
    let unsubscribeOrders = null;
    const ordersTbody = document.getElementById('ordersTbody');
    const statCount = document.getElementById('statCount');

    function stopOrdersListener(){
      if(typeof unsubscribeOrders === 'function') unsubscribeOrders();
      unsubscribeOrders = null;
      ordersTbody.innerHTML = '';
      statCount.innerText = '0';
    }

    function openAdminPanel(){
      // افتح المودال
      adminPanelModal.classList.add('open');

      // استمع لطلبات firestore بترتيب حسب الاحدث
      const q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
      unsubscribeOrders = onSnapshot(q, (snap)=>{
        ordersTbody.innerHTML = '';
        statCount.innerText = snap.size;
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const id = docSnap.id;
          const tr = document.createElement('tr');

          const timeCell = `<td style="min-width:150px">${fmtDate(d.createdAt)}</td>`;
          const packCell = `<td>${d.packageCount || '-'} متابع</td>`;
          const userCell = `<td>${d.igUser || '-'}</td>`;
          const phoneCell = `<td>${d.phone || '-'}</td>`;
          const priceCell = `<td>${(d.price!==undefined)?d.price+' ج':'-'}</td>`;
          const receiptCell = `<td>${d.receiptURL?`<a href="${d.receiptURL}" target="_blank">عرض</a>`:'-'}</td>`;
          const statusClass = (d.status && d.status.includes('تم')) ? 'status-done' : 'status-pending';
          const statusCell = `<td><span class="badge ${statusClass}">${d.status || '-'}</span></td>`;

          const actionsCell = document.createElement('td');
          // action buttons
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = (d.status && d.status.includes('تم')) ? 'إرجاع لقيد المراجعة' : 'تم التسليم';
          toggleBtn.style.marginRight = '6px';
          toggleBtn.addEventListener('click', async ()=>{
            try{
              const newStatus = (d.status && d.status.includes('تم')) ? 'قيد المراجعة ⏳' : 'تم الاستلام ✅';
              await updateDoc(doc(db, 'orders', id), { status: newStatus });
            }catch(err){ console.error(err); alert('فشل تحديث الحالة') }
          });

          const delBtn = document.createElement('button');
          delBtn.textContent = 'حذف';
          delBtn.style.background = '#ef4444';
          delBtn.style.color = '#fff';
          delBtn.addEventListener('click', async ()=>{
            if(!confirm('هل متأكد من حذف هذا الطلب؟')) return;
            try{
              // حذف الوثيقة
              const docRef = doc(db, 'orders', id);
              // حاول نحذف الملف من storage لو فيه receiptPath
              if(d.receiptPath){
                try{ await deleteObject(sRef(storage, d.receiptPath)); }catch(e){ console.warn('حذف الإيصال فشل أو غير موجود', e) }
              }
              await deleteDoc(docRef);
            }catch(err){ console.error(err); alert('فشل حذف الطلب') }
          });

          actionsCell.appendChild(toggleBtn);
          actionsCell.appendChild(delBtn);

          tr.innerHTML = timeCell + packCell + userCell + phoneCell + priceCell + receiptCell + statusCell;
          const tdActions = document.createElement('td'); tdActions.appendChild(actionsCell);
          tr.appendChild(tdActions);

          ordersTbody.appendChild(tr);
        });
      }, (err) => {
        console.error('snapshot error', err);
        alert('حدث خطأ أثناء جلب الطلبات');
      });
    }

    // اغلاق المودال اذا ضغط على السطح الخارجي
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click', (e)=>{ if(e.target === m) { m.classList.remove('open'); } });
    });

  </script>
</body>
</html>
